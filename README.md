# uProtocol C++ Interface Library (up-cpp)

[![CI](https://github.com/eclipse-uprotocol/up-cpp/actions/workflows/ci.yml/badge.svg)](https://github.com/eclipse-uprotocol/up-cpp/actions/workflows/ci.yml)

## Welcome!

This library provides the primary interface to uProtocol for uEntity
applications. The primary point of interaction for most applications will be the
layer 2 "communications" objects.

In addition to `up-cpp`, a uEntity will also need at least on transport
implementation, such as [up-transport-zenoh-cpp][zenoh-transport-repo].

*_IMPORTANT NOTE:_ This project is under active development*

## Getting Started

### Requirements:
- Compiler: GCC/G++ 11 or Clang 13
- Conan : 1.59 or latest 2.x

#### Conan packages

Using the recipes found in [up-conan-recipes][conan-recipe-repo], build these
Conan packages:

1. [up-core-api][spec-repo]: `conan create --version 1.6.0-alpha4 --build=missing up-core-api/release`

**NOTE:** all `conan` commands in this document use  Conan 2.x syntax. Please
adjust accordingly when using Conan 1.x.

## How to Use the Library

To add up-cpp to your conan build dependencies, place following in your
[conanfile.txt][conan-txt-reference]:

```
[requires]
up-cpp/[~1.0]

[generators]
CMakeDeps
CMakeToolchain

[layout]
cmake_layout
```

**NOTE:** If using conan version 1.59 Ensure that the conan profile is
configured to use ABI 11 (libstdc++11: New ABI) standards according to
[the Conan documentation for managing gcc ABIs][conan-abi-docs].

## Building locally

The following steps are only required for developers to locally build and test
up-cpp, If you are making a project that uses up-cpp, follow the steps in the
[How to Use the Library](#how-to-use-the-library) section above.

### With Conan for dependencies

From the root of this repo, run:

```bash
conan install --build=missing .
cmake --preset conan-release
cd build/Release
cmake --build . -- -j
```

Once the build completes, tests can be run with `ctest`.

Debug builds can be generated by changing those steps to:

```bash
conan install --build=missing --settings=build_type=Debug .
cmake --preset conan-debug
cd build/Debug
cmake --build . -- -j
```

### With Conan for QNX

Before building **up-cpp** we need to build all dependencies from **up-conan-recipes**:

Pre-requisite:

* Install venv
  - https://docs.python.org/3/library/venv.html
* Install Conan2
  - https://docs.conan.io/2/installation.html
* Install QNX license and SDP installation (~/.qnx and ~/qnx800 by default)
  - https://www.qnx.com/products/everywhere/ (**Non-Commercial Use**)

```bash
mkdir workspace
cd workspace
# setup python virtual environment
# python -m venv /path/to/new/virtual/environment
# for example:
python -m venv vpy
# source local venv
source vpy/bin/activate
# install conan
pip install conan
# setup conan linux build profile
conan profile detect
# clone conan recipes
git clone https://github.com/qnx-ports/up-conan-recipes.git
# clone up-cpp
git clone https://github.com/qnx-ports/up-cpp.git
# source QNX SDP
source <QNX_SDP>/qnxsdp-env.sh
# build protobuf v3.21.12 for Linux build system
conan create --version=3.21.12 --build=missing up-conan-recipes/protobuf
# build protobuf for QNX host
# for example QNX7.1 arch=aarch64le
conan create -pr:h=up-conan-recipes/tools/profiles/nto-7.1-aarch64-le --version=3.21.12 up-conan-recipes/protobuf
# build up-core-api for QNX host
conan create -pr:h=up-conan-recipes/tools/profiles/nto-7.1-aarch64-le --version 1.6.0-alpha2 up-conan-recipes/up-core-api/release
# build all requirements for up-cpp
conan create -pr:h=up-conan-recipes/tools/profiles/nto-7.1-aarch64-le --version=10.2.1 up-conan-recipes/fmt/all
conan create -pr:h=up-conan-recipes/tools/profiles/nto-7.1-aarch64-le --version=1.13.0 up-conan-recipes/spdlog/all
conan create -pr:h=up-conan-recipes/tools/profiles/nto-7.1-aarch64-le  --version=1.13.0 up-conan-recipes/gtest
# build local up-cpp as a static lib
conan install -pr:h=up-conan-recipes/tools/profiles/nto-7.1-aarch64-le --version 1.0.1 up-cpp
# or as a shared lib
conan install -pr:h=up-conan-recipes/tools/profiles/nto-7.1-aarch64-le --version 1.0.1 -o shared=True  up-cpp
cd up-cpp
cmake --preset conan-release
cd build/Release
cmake --build . -- -j
# all tests you can find under build/Release/bin/
# if you build as a shared lib you can find it under build/Release/lib/
# you just need to scp whem to the QNX target
# define target IP address
TARGET_HOST=<target-ip-address-or-hostname>
# copy test binaries to your QNX target
scp -r up-cpp/build/Release/bin qnxuser@$TARGET_HOST:/data/home/qnxuser/
scp -r up-cpp/build/Release/lib qnxuser@$TARGET_HOST:/data/home/qnxuser/
# ssh into the target
ssh qnxuser@$TARGET_HOST
# Run tests
# Don't forget to add path for *.so lib to LD_LIBRARY_PATH
cd /data/home/qnxuser/
```

### Generate UT Coverage

To get code coverage, perform the steps above, but replace `cmake --preset...` with
```
cd build/Release
cmake ../../ -DCMAKE_TOOLCHAIN_FILE=generators/conan_toolchain.cmake -DCMAKE_BUILD_TYPE=Coverage
```
Once the tests complete, the Unit Test Coverage report can be generated from the base up-cpp folder with: ./Coverage.sh
```
./coverage.sh
```

### With dependencies installed as system libraries

**TODO** Verify steps for pure cmake build without Conan.

### Creating the Conan package

See: [up-conan-recipes][conan-recipe-repo]

## Show your support

Give a ⭐️ if this project helped you!

[zenoh-transport-repo]: https://github.com/eclipse-uprotocol/up-transport-zenoh-cpp
[conan-recipe-repo]: https://github.com/eclipse-uprotocol/up-conan-recipes
[spec-repo]: https://github.com/eclipse-uprotocol/up-spec
[conan-abi-docs]: https://docs.conan.io/en/1.60/howtos/manage_gcc_abi.html
[conan-txt-reference]: https://docs.conan.io/2/reference/conanfile_txt.html
